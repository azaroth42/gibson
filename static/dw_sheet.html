<!DOCTYPE html>
<html>

<head>
    <title>Dungeon World Sheet</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Merriweather&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/static/dw_sheet.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <style>
        /* Inline overrides for new layout */
        #stats-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .option-group {
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #433;
        }

        .option-group label {
            display: block;
            font-family: 'Cinzel', serif;
            color: rgb(47, 25, 2);
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .option-select {
            width: 100%;
            padding: 5px;
            background: #222;
            color: #eee;
            border: 1px solid #544;
            font-family: 'Merriweather', serif;
        }

        .look-box {
            width: 100%;
            height: 60px;
            background: #222;
            color: #eee;
            border: 1px solid #544;
            padding: 5px;
            font-family: 'Merriweather', serif;
            resize: vertical;
        }

        .option-desc {
            font-size: 0.85em;
            color: #460606;
            margin-top: 5px;
            font-style: italic;
        }
    </style>
</head>

<body>

    <h1 id="char-name">Character Name</h1>
    <h3 id="char-class" style="color:#644; margin-top:-20px;">Class Level 1</h3>

    <div class="sheet-container">
        <div class="sidebar">
            <h3 style="text-align:center;">Stats</h3>
            <div id="stats-container">
                <!-- Stat Boxes -->
            </div>

            <!-- Alignment & Race -->
            <div style="margin-top:30px; padding:0 10px;">
                <div class="option-group">
                    <label>Alignment</label>
                    <select id="alignment-select" class="option-select"
                        onchange="updateOption('alignment', this.value)"></select>
                    <div id="alignment-desc" class="option-desc"></div>
                </div>

                <div class="option-group">
                    <label>Race</label>
                    <select id="race-select" class="option-select" onchange="updateOption('race', this.value)"></select>
                    <div id="race-desc" class="option-desc"></div>
                </div>

            </div>

            <h3 style="text-align:center; margin-top:30px;">Vitals</h3>
            <div class="vitals-grid">
                <!-- Row 1 -->
                <div class="vital-box">
                    <div style="font-size:0.8em; color:#a00;">HP</div>
                    <div style="display:flex; align-items:center; justify-content:center; gap:5px;">
                        <span id="current-hp" class="stat-val">20</span> / <span id="max-hp">20</span>
                    </div>
                    <div style="margin-top:5px;">
                        <button class="btn" style="padding:0 5px; font-size:0.8em;"
                            onclick="updateVital('current_hp', -1)">-</button>
                        <button class="btn" style="padding:0 5px; font-size:0.8em;"
                            onclick="updateVital('current_hp', 1)">+</button>
                    </div>
                </div>
                <div class="vital-box">
                    <div style="font-size:0.8em;">Armor</div>
                    <span id="armor" class="stat-val">0</span>
                    <div style="margin-top:5px;">
                        <button class="btn" style="padding:0 5px; font-size:0.8em;"
                            onclick="updateVital('armor', -1)">-</button>
                        <button class="btn" style="padding:0 5px; font-size:0.8em;"
                            onclick="updateVital('armor', 1)">+</button>
                    </div>
                </div>

                <!-- Row 2 -->
                <div class="vital-box">
                    <div style="font-size:0.8em;">XP</div>
                    <span id="xp" class="stat-val">0</span>
                    <div style="margin-top:5px;">
                        <button class="btn" style="padding:0 5px; font-size:0.8em;"
                            onclick="updateVital('xp', -1)">-</button>
                        <button class="btn" style="padding:0 5px; font-size:0.8em;"
                            onclick="updateVital('xp', 1)">+</button>
                    </div>
                </div>
                <div class="vital-box">
                    <div style="font-size:0.8em; color:#a80;">Coin</div>
                    <span id="coin" class="stat-val">0</span>
                </div>
            </div>

            <div class="vital-box" style="margin-top:15px;">
                <div style="font-size:0.8em; color:#800;">Damage Die</div>
                <span id="damage-die" class="stat-val" style="font-family:'Cinzel', serif;">-</span>
            </div>

            <div class="option-group" style="margin-top:20px;">
                <label>Look</label>
                <textarea id="look-input" class="look-box" onblur="updateLook(this.value)"
                    placeholder="Describe your look..."></textarea>
            </div>
        </div>

        <div class="main-content">
            <!-- Look Removed (Moved to Sidebar) -->

            <h2>Moves</h2>
            <div id="moves-container">
                <!-- Moves -->
            </div>

            <h2>Gear <span style="font-size:0.6em; float:right;">Load: <span id="load">0</span>/10</span></h2>
            <div id="gear-container">
                <!-- Items -->
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const charId = urlParams.get('id');
        let charData = null;
        let availableOptions = [];

        const STATS = ['str', 'dex', 'con', 'int', 'wis', 'cha'];
        const NAMES = {
            'str': 'Strength', 'dex': 'Dexterity', 'con': 'Constitution',
            'int': 'Intelligence', 'wis': 'Wisdom', 'cha': 'Charisma'
        };

        async function init() {
            await fetchChar();
            await fetchOptions();
            render();
        }

        async function fetchChar() {
            const res = await fetch(`/dw/characters/${charId}`);
            charData = await res.json();
        }

        async function fetchOptions() {
            if (!charData) return;
            const res = await fetch(`/dw/options?hero_class=${charData.hero_class}`);
            availableOptions = await res.json();
        }

        function render() {
            if (!charData) return;

            document.getElementById('char-name').textContent = charData.name;
            document.getElementById('char-class').textContent = `${charData.hero_class} Level ${charData.level}`;
            document.getElementById('max-hp').textContent = charData.max_hp;
            document.getElementById('coin').textContent = charData.coin;

            // Look
            const lookInput = document.getElementById('look-input');
            if (document.activeElement !== lookInput) {
                lookInput.value = charData.look || "";
            }

            // Options (Alignment/Race)
            const canEditOptions = (charData.level === 1 && charData.xp === 0);
            renderOptionSelect('alignment', 'alignment-select', 'alignment-desc', canEditOptions);
            renderOptionSelect('race', 'race-select', 'race-desc', canEditOptions);

            // Render Damage Die
            const damageOpt = availableOptions.find(o => o.type === 'damage_die');
            document.getElementById('damage-die').textContent = damageOpt ? damageOpt.description : "d6";

            // Vitals
            document.getElementById('current-hp').textContent = charData.current_hp;
            document.getElementById('max-hp').textContent = charData.max_hp;
            document.getElementById('armor').textContent = charData.armor;
            document.getElementById('xp').textContent = charData.xp;

            // Stats
            renderStats();

            // Moves
            renderMoves();

            // Gear
            renderGear();
        }

        function renderOptionSelect(type, selectId, descId, canEdit) {
            const select = document.getElementById(selectId);
            const desc = document.getElementById(descId);
            const currentVal = charData[type];

            // Filter options by type
            const options = availableOptions.filter(o => o.type === type);

            // Use disabled property to lock the select element
            select.disabled = !canEdit;

            // Save selection if rebuilding
            const savedVal = select.value;
            select.innerHTML = '';

            // Default option if none selected
            if (!currentVal) {
                const def = document.createElement('option');
                def.value = "";
                def.text = "Select...";
                select.appendChild(def);
            }

            options.forEach(opt => {
                const el = document.createElement('option');
                el.value = opt.name; // Store Name as value
                el.text = opt.name;
                el.dataset.desc = opt.description;
                if (opt.name === currentVal) el.selected = true;
                select.appendChild(el);
            });

            // Update description
            const selectedOpt = options.find(o => o.name === (currentVal || select.value));
            desc.textContent = selectedOpt ? selectedOpt.description : "";
        }

        function renderStats() {
            const statsDiv = document.getElementById('stats-container');
            const canEditStats = (charData.level === 1 && charData.xp === 0);

            statsDiv.innerHTML = '';

            // Validation (Standard Array)
            if (canEditStats) {
                const TARGET_STATS = [16, 15, 13, 12, 9, 8];
                const currentStats = STATS.map(k => charData[k]).sort((a, b) => b - a);
                const isValid = JSON.stringify(currentStats) === JSON.stringify(TARGET_STATS);
                const statusColor = isValid ? 'green' : '#a33';
                const gridSpan = document.createElement('div');
                gridSpan.style.gridColumn = "1 / -1";
                gridSpan.style.textAlign = "center";
                gridSpan.style.fontWeight = "bold";
                gridSpan.style.color = statusColor;
                gridSpan.textContent = isValid ? 'Valid Stats' : 'Assign: 16, 15, 13, 12, 9, 8';
                statsDiv.appendChild(gridSpan);
            }

            STATS.forEach(key => {
                const val = charData[key];
                const mod = valToMod(val);
                const sign = mod >= 0 ? '+' : '';

                let controls = '';
                if (canEditStats) {
                    controls = `
                        <div style="margin-top:5px; display:flex; justify-content:center; gap:5px;">
                            <button class="btn" style="padding:0 5px; font-size:0.8em;" onclick="updateStat('${key}', -1)">-</button>
                            <button class="btn" style="padding:0 5px; font-size:0.8em;" onclick="updateStat('${key}', 1)">+</button>
                        </div>
                    `;
                }

                const box = document.createElement('div');
                box.className = 'stat-box';
                box.innerHTML = `
                    <div style="font-size:0.9em; text-transform:uppercase;">${NAMES[key]}</div>
                    <div class="stat-val">${val}</div>
                    <div class="stat-mod">${sign}${mod}</div>
                    ${controls}
                `;
                statsDiv.appendChild(box);
            });
        }

        function valToMod(val) {
            if (val >= 18) return 3;
            if (val >= 16) return 2;
            if (val >= 13) return 1;
            if (val >= 9) return 0;
            if (val >= 6) return -1;
            if (val >= 4) return -2;
            return -3;
        }

        function renderMoves() {
            const movesDiv = document.getElementById('moves-container');
            movesDiv.innerHTML = '';

            const classMoves = charData.moves.filter(m => m.type !== 'basic' && m.type !== 'special');
            const basicMoves = charData.moves.filter(m => m.type === 'basic');
            const specialMoves = charData.moves.filter(m => m.type === 'special');

            if (classMoves.length > 0) {
                const header = document.createElement('h3');
                header.textContent = 'Class Moves';
                movesDiv.appendChild(header);
                classMoves.forEach(m => movesDiv.appendChild(createMoveCard(m, true)));
            }

            renderMoveSection(movesDiv, 'Basic Moves', basicMoves, false);
            renderMoveSection(movesDiv, 'Special Moves', specialMoves, false);
        }

        function renderMoveSection(container, title, moves, startExpanded) {
            if (moves.length === 0) return;
            const wrapper = document.createElement('div');
            wrapper.style.marginBottom = '20px';
            const header = document.createElement('div');
            header.className = 'section-header';
            header.style.cssText = "cursor:pointer; font-family:'Cinzel',serif; color:#522; font-size:1.2em; font-weight:bold; border-bottom:1px solid #522; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;";
            header.innerHTML = `<span>${title}</span> <span style="font-size:0.8em;">${startExpanded ? '▼' : '▶'}</span>`;
            const content = document.createElement('div');
            content.style.display = startExpanded ? 'block' : 'none';
            header.onclick = () => {
                const isHidden = content.style.display === 'none';
                content.style.display = isHidden ? 'block' : 'none';
                header.lastElementChild.textContent = isHidden ? '▼' : '▶';
            };
            moves.forEach(m => content.appendChild(createMoveCard(m, false)));
            wrapper.appendChild(header);
            wrapper.appendChild(content);
            container.appendChild(wrapper);
        }

        function createMoveCard(m, defaultDescVisible = false) {
            const card = document.createElement('div');
            card.className = 'move-card';
            const displayStyle = defaultDescVisible ? 'block' : 'none';
            card.innerHTML = `
                <div class="move-header" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display==='none'?'block':'none'">
                    <span>${m.name}</span>
                    <span style="font-size:0.8em; color:#888;">${m.type}</span>
                </div>
                <div class="move-desc" style="display:${displayStyle};">
                    ${marked.parse(m.description || "")}
                </div>
             `;
            return card;
        }

        function renderGear() {
            const gearDiv = document.getElementById('gear-container');
            gearDiv.innerHTML = '';
            let totalLoad = 0;
            charData.items.forEach(i => {
                totalLoad += (i.weight * i.qty);
                const row = document.createElement('div');
                row.className = 'item-row';
                row.innerHTML = `<span>${i.name} (x${i.qty})</span><span style="color:#777;">${i.weight} wt</span>`;
                gearDiv.appendChild(row);
            });
            document.getElementById('load').textContent = totalLoad;
        }

        async function updateOption(key, value) {
            if (!value) return;
            await updateCharFields({ [key]: value });
        }

        async function updateLook(value) {
            if (value === charData.look) return;
            await updateCharFields({ look: value });
        }

        async function updateVital(key, delta) {
            const currentVal = charData[key];
            let newVal = currentVal + delta;
            // Clamping
            if (key === 'current_hp') {
                if (newVal < 0) newVal = 0;
                if (newVal > charData.max_hp) newVal = charData.max_hp;
            } else {
                if (newVal < 0) newVal = 0;
            }
            await updateCharFields({ [key]: newVal });
        }

        async function updateStat(stat, delta) {
            const newVal = charData[stat] + delta;
            if (newVal < 1 || newVal > 18) return;
            await updateCharFields({ [stat]: newVal });
        }

        async function updateCharFields(fields) {
            const res = await fetch(`/dw/characters/${charId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(fields)
            });
            if (res.ok) {
                charData = await res.json();
                render();
            } else {
                alert("Error updating character");
            }
        }

        init();
    </script>
</body>

</html>